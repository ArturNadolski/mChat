/**
 *
 * @package mChat JavaScript Code mini
 * @version 1.5.0 of 2015-12-27
 * @copyright (c) 2009 By Shapoval Andrey Vladimirovich (AllCity) ~ http://allcity.net.ru/
 * @copyright (c) 2013 By Rich McGirr (RMcGirr83) http://rmcgirr83.org
 * @copyright (c) 2015 By dmzx - http://www.dmzx-web.net
 * @copyright (c) 2015 By kasimi
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 *
 */
String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),String.prototype.capitalize||(String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}),"undefined"==typeof document.hasFocus&&(document.hasFocus=function(){return"visible"==document.visibilityState}),jQuery(function(e){var t={url:mChat.file,timeout:1e4,type:"POST",error:function(e,t,a){400==e.status?alert(mChat.flood):403==e.status?alert(mChat.noAccess):501==e.status?alert(mChat.noMessageInput):"undefined"!=typeof console&&console.log&&console.log("AJAX error. status: "+t+", message: "+a)}},a=function(e){return new Date(1e3*e).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]};e.extend(mChat,{clear:function(){""!==mChat.$elem("input").val()&&(confirm(mChat.clearConfirm)&&(mChat.resetSession(),mChat.$elem("input").val("")),mChat.$elem("input").focus())},sound:function(e){Cookies.get("mChatNoSound")||(e=mChat.extUrl+"sounds/"+e+".swf",navigator.userAgent.match(/MSIE ([0-9]+)\./)||navigator.userAgent.match(/Trident\/7.0; rv 11.0/)?mChat.$elem("sound").html('<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" height="0" width="0" type="application/x-shockwave-flash"><param name="movie" value="'+e+'"></object>'):mChat.$elem("sound").html('<embed src="'+e+'" width="0" height="0" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash"></embed>'))},notice:function(){document.hasFocus()||e.titleAlert(mChat.newMessageAlert,{interval:1e3})},toggle:function(t){var a=e("#mchat-"+t);a.slideToggle(function(){var e="mChatShow"+t.capitalize();a.is(":visible")?Cookies.set(e,"yes"):Cookies.remove(e)})},add:function(){if(!mChat.submitting&&""!==mChat.$elem("input").val()){var a=mChat.$elem("input").val().replace(/ /g,"");if(mChat.mssgLngth&&a.length>mChat.mssgLngth)return void alert(mChat.mssgLngthLong);var s=e("#"+form_name+" :input[name]").filter(function(e,t){return!t.name.startsWith("addbbcode")});e.ajax(e.extend({},t,{data:s.serialize(),beforeSend:function(){mChat.$elem("add").attr("disabled","disabled"),mChat.pauseSession()},success:mChat.refresh,complete:function(){mChat.resetSession(),mChat.$elem("input").val("").focus(),mChat.$elem("add").removeAttr("disabled")}}))}},edit:function(){var a=e(this).closest(".mchat-message"),s=mChat.$elem("confirm").find("textarea").show().val(a.data("edit"));mChat.$elem("confirm").find("p").text(mChat.editInfo),phpbb.confirm(mChat.$elem("confirm"),function(){e.ajax(e.extend({},t,{data:{mode:"edit",message_id:a.data("id"),message:s.val()},success:function(t){a.fadeOut("slow",function(){a.replaceWith(e(t.edit).hide().fadeIn("slow"))})},complete:function(){s.val(""),mChat.resetSession(),mChat.archiveMode||mChat.messageTop||setTimeout(function(){mChat.$elem("main").animate({scrollTop:mChat.$elem("main")[0].scrollHeight},"slow","swing")},250)}}))})},del:function(){var a=e(this).closest(".mchat-message");mChat.$elem("confirm").find("textarea").hide(),mChat.$elem("confirm").find("p").text(mChat.delConfirm),phpbb.confirm(mChat.$elem("confirm"),function(){e.ajax(e.extend({},t,{data:{mode:"del",message_id:a.data("id")},success:function(e){e.del&&(mChat.sound("del"),a.fadeOut("slow",function(){a.remove()}))},complete:mChat.resetSession}))})},refresh:function(){var a=mChat.messageTop?":first":":last",s=mChat.$elem("messages").children(a).data("id");e.ajax(e.extend({},t,{data:{mode:"refresh",message_last_id:s},beforeSend:function(){e("#mchat-refresh-ok,#mchat-refresh-error,#mchat-refresh-paused").hide(),mChat.$elem("refresh-load").show()},success:function(t){var a=e(t.refresh);a.length&&(mChat.$elem("no-messages").remove(),mChat.$elem("messages")[mChat.messageTop?"prepend":"append"](a.hide()),a.css("opacity",0).slideDown("slow").animate({opacity:1},{queue:!1,duration:"slow"}),mChat.$elem("main").animate({scrollTop:mChat.messageTop?0:mChat.$elem("main")[0].scrollHeight},"slow"),mChat.sound("add"),mChat.notice()),setTimeout(function(){e("#mchat-refresh-load,#mchat-refresh-error,#mchat-refresh-paused").hide(),mChat.$elem("refresh-ok").show(),mChat.$elem("refresh-text").html(mChat.refreshYes)},250)},error:function(){e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-paused").hide(),mChat.$elem("refresh-error").show(),mChat.sound("error")}}))},whois:function(){e.ajax(e.extend({},t,{data:{mode:"whois"},beforeSend:function(){mChat.customPage&&(mChat.$elem("refresh-pending").show(),mChat.$elem("refresh").hide())},success:function(e){mChat.$elem("whois").replaceWith(e.whois),mChat.customPage&&setTimeout(function(){mChat.$elem("refresh-pending").hide(),mChat.$elem("refresh").show()},250)},error:function(){mChat.sound("error")},complete:function(){mChat.$elem("userlist").length&&(Cookies.get("mChatShowUserlist")||mChat.customPage)&&mChat.$elem("userlist").css("display","block")}}))},countDown:function(){mChat.sessionTime-=1;var e=a(mChat.sessionTime);mChat.$elem("session").html(mChat.sessEnds+" "+e),mChat.sessionTime<=0&&mChat.endSession()},pauseSession:function(){mChat.submitting=!0,clearInterval(mChat.refreshInterval),mChat.userTimeout&&clearInterval(mChat.sessionCountdown),mChat.whoisRefresh&&clearInterval(mChat.whoisInterval)},resetSession:function(){clearInterval(mChat.refreshInterval),mChat.refreshInterval=setInterval(mChat.refresh,mChat.refreshTime),mChat.userTimeout&&(mChat.sessionTime=mChat.userTimeout/1e3,clearInterval(mChat.sessionCountdown),mChat.sessionCountdown=setInterval(mChat.countDown,1e3),mChat.$elem("session").html(mChat.sessEnds+" "+a(mChat.sessionTime))),mChat.whoisRefresh&&(clearInterval(mChat.whoisInterval),mChat.whoisInterval=setInterval(mChat.whois,mChat.whoisRefresh)),mChat.pause&&mChat.$elem("input").one("keypress",mChat.endSession),mChat.$elem("refresh-ok").show(),e("#mchat-refresh-load,#mchat-refresh-error,#mchat-refresh-paused").hide(),mChat.$elem("refresh-text").html(mChat.refreshYes),mChat.submitting=!1},endSession:function(){clearInterval(mChat.refreshInterval),mChat.userTimeout&&(clearInterval(mChat.sessionCountdown),mChat.$elem("session").html(mChat.sessOut)),mChat.whoisRefresh&&clearInterval(mChat.whoisInterval),e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-error").hide(),mChat.$elem("refresh-paused").show(),mChat.$elem("refresh-text").html(mChat.refreshNo)},mention:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=t.data("usercolor");s?a="[b][color="+s+"]"+a+"[/color][/b]":mChat.allowBBCodes&&(a="[b]"+a+"[/b]"),insert_text("@ "+a+", ")},quote:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=mChat.entityDecode(t.data("edit"));insert_text('[quote="'+a+'"] '+s+"[/quote]")},like:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=mChat.entityDecode(t.data("edit"));insert_text(mChat.likes+'[quote="'+a+'"] '+s+"[/quote]")},entityDecode:function(e){var t=decodeURIComponent(e.replace(/\+/g," "));return t=t.replace(/&lt;/g,"<"),t=t.replace(/&gt;/g,">"),t=t.replace(/&#58;/g,":"),t=t.replace(/&#46;/g,"."),t=t.replace(/&amp;/g,"&"),t=t.replace(/&quot;/g,"'")},$elem:function(t){return mChat.cache[t]||(mChat.cache[t]=e("#mchat-"+t)),mChat.cache[t]}}),mChat.cache={},mChat.$elem("confirm").detach().show(),mChat.archiveMode||(e.fn.autoGrowInput=function(){return this.filter("input:text").each(function(){var t=20,a=e(this).width(),s="",o=e(this),m=e("<div>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:o.css("fontSize"),fontFamily:o.css("fontFamily"),fontWeight:o.css("fontWeight"),letterSpacing:o.css("letterSpacing"),whiteSpace:"nowrap"});m.insertAfter(o),e(this).on("keypress blur change submit focus",function(){if(s!==(s=o.val())){var h=s.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;"),n=m.html(h).width(),i=n+t>=a?n+t:a;(i<o.width()&&i>=a||i>a&&i<e(".mchat-panel").width()-t)&&o.width(i)}})}),this},mChat.resetSession(),mChat.messageTop||mChat.$elem("main").animate({scrollTop:mChat.$elem("main")[0].scrollHeight},"slow","swing"),mChat.$elem("input").autoGrowInput(),mChat.playSound&&Cookies.get("mChatNoSound")?mChat.$elem("user-sound").removeAttr("checked"):(mChat.$elem("user-sound").attr("checked","checked"),Cookies.remove("mChatNoSound")),mChat.$elem("user-sound").change(function(){this.checked?Cookies.remove("mChatNoSound"):Cookies.set("mChatNoSound","yes")}),mChat.$elem("colour").html(phpbb.colorPalette("h",15,10)).on("click","a",function(t){var a=e(this).data("color");bbfontstyle("[color=#"+a+"]","[/color]"),t.preventDefault()}),Cookies.get("mChatShowSmilies")&&mChat.$elem("smilies").slideToggle("slow"),Cookies.get("mChatShowBbcodes")&&mChat.$elem("bbcodes").slideToggle("slow",function(){Cookies.get("mChatShowColour")&&mChat.$elem("colour").slideToggle("slow")}),mChat.$elem("userlist").length&&(Cookies.get("mChatShowUserlist")||mChat.customPage)&&mChat.$elem("userlist").slideToggle("slow"),e("#postform").on("keypress",function(e){13==e.which&&(mChat.add(),e.preventDefault())})),mChat.$elem("body").on("click","[data-mchat-action]",function(t){var a=e(this).data("mchat-action");mChat[a].call(this),t.preventDefault()}),mChat.$elem("body").on("click","[data-mchat-toggle]",function(t){var a=e(this).data("mchat-toggle");mChat.toggle(a),t.preventDefault()})});
