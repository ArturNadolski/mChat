/**
 *
 * @package mChat JavaScript Code mini
 * @version 1.4.4 of 2013-11-03
 * @copyright (c) 2009 By Shapoval Andrey Vladimirovich (AllCity) ~ http://allcity.net.ru/
 * @copyright (c) 2013 By Rich McGirr (RMcGirr83) http://rmcgirr83.org
 * @copyright (c) 2015 By dmzx - http://www.dmzx-web.net
 * @copyright (c) 2015 By kasimi
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 *
 */
jQuery(function(e){var t=!0;mChat.archiveMode||(e.fn.autoGrowInput=function(){return this.filter("input:text").each(function(){var t=20,a=e(this).width(),s="",h=e(this),o=e("<div/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:h.css("fontSize"),fontFamily:h.css("fontFamily"),fontWeight:h.css("fontWeight"),letterSpacing:h.css("letterSpacing"),whiteSpace:"nowrap"});o.insertAfter(h),e(this).on("keypress blur change submit focus",function(){if(s!==(s=h.val())){var r=s.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;"),m=o.html(r).width(),n=m+t>=a?m+t:a;(n<h.width()&&n>=a||n>a&&n<e(".mchat-panel").width()-t)&&h.width(n)}})}),this},e("input#mchat-input").autoGrowInput(),mChat.messageTop||e("#mchat-main").animate({scrollTop:e("#mchat-main")[0].scrollHeight},"slow","swing"),mChat.pause&&e("#mchat-input").on("keypress",function(){clearInterval(mChat.interval),e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-error").hide(),e("#mchat-refresh-text").html(mChat.refreshNo).addClass("mchat-alert"),e("#mchat-refresh-paused").show()}),e([window,document]).blur(function(){t=!1}).focus(function(){t=!0}),mChat.playSound&&"yes"!=e.cookie("mChatNoSound")?(e.cookie("mChatNoSound",null),e("#mchat-user-sound").attr("checked","checked")):(e.cookie("mChatNoSound","yes"),e("#mchat-user-sound").removeAttr("checked")),e("#mchat-userlist").length&&("yes"==e.cookie("mChatShowUserList")||mChat.customPage)&&e("#mchat-userlist").show());var a={url:mChat.file,timeout:1e4,type:"POST",error:function(e,t,a){400==e.status?alert(mChat.flood):403==e.status?alert(mChat.noAccess):501==e.status?alert(mChat.noMessageInput):"undefined"!=typeof console&&console.log&&console.log("AJAX error. status: "+t+", message: "+a)}};e.extend(mChat,{countDown:function(){e("#mchat-session").removeClass("mchat-alert"),mChat.sessionTime=mChat.sessionTime-1;var t=Math.floor(mChat.sessionTime),a=Math.floor(t/60),s=Math.floor(a/60);t%=60,9>=t&&(t="0"+t),a%=60,9>=a&&(a="0"+a),s%=60,9>=s&&(s="0"+s);var h=s+":"+a+":"+t;e("#mchat-session").html(mChat.sessEnds+" "+h),mChat.sessionTime<=0&&(clearInterval(mChat.counter),e("#mchat-session").html(mChat.sessOut).addClass("mchat-alert"))},clear:function(){""!==e("#mchat-input").val()&&(confirm(mChat.clearConfirm)&&(e("#mchat-refresh-text").removeClass("mchat-alert"),!mChat.archiveMode&&mChat.pause&&(mChat.interval=setInterval(mChat.refresh,mChat.refreshTime)),e("#mchat-refresh-ok").show(),e("#mchat-refresh-load,#mchat-refresh-error,#mchat-refresh-paused").hide(),e("#mchat-refresh-text").html(mChat.refreshYes),e("#mchat-input").val("")),e("#mchat-input").focus())},sound:function(t){"yes"!=e.cookie("mChatNoSound")&&(t=mChat.extUrl+"sounds/"+t+".swf",navigator.userAgent.match(/MSIE ([0-9]+)\./)||navigator.userAgent.match(/Trident\/7.0; rv 11.0/)?e("#mchat-sound").html('<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" height="0" width="0" type="application/x-shockwave-flash"><param name="movie" value="'+t+'"></object>'):e("#mchat-sound").html('<embed src="'+t+'" width="0" height="0" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash"></embed>'))},notice:function(){t&&document.hasFocus()||e.titleAlert(mChat.newMessageAlert,{interval:1e3})},toggle:function(t){var a=e("#mchat-"+t);a.slideToggle(function(){a.is(":visible")?e.cookie("mChatShow"+t,"yes"):a.is(":hidden")&&e.cookie("mChatShow"+t,null)})},add:function(){if(!mChat.submitting&&""!==e("#mchat-input").val()){var t=e("#mchat-input").val().replace(/ /g,"");if(mChat.mssgLngth&&t.length>mChat.mssgLngth)return void alert(mChat.mssgLngthLong);var s=e("#"+form_name+" :input[name]").filter(function(e,t){return!t.name.startsWith("addbbcode")});e.ajax(e.extend({},a,{data:s.serialize(),beforeSend:function(){e("#mchat-add").attr("disabled","disabled"),mChat.userTimeout&&(clearInterval(mChat.activeInterval),clearInterval(mChat.counter)),clearInterval(mChat.interval),mChat.submitting=!0},success:mChat.refresh,complete:function(){e("#mchat-input").val("").focus(),e("#mchat-add").removeAttr("disabled"),mChat.interval=setInterval(mChat.refresh,mChat.refreshTime),mChat.submitting=!1,mChat.userTimeout&&(mChat.sessionTime=mChat.userTimeout/1e3,mChat.counter=setInterval(mChat.countDown,1e3),mChat.activeInterval=setInterval(mChat.active,mChat.userTimeout))}}))}},edit:function(){var t=e(this).closest(".mchat-message"),s=mChat.confirmContainer.find("textarea").show().val(t.data("edit"));mChat.confirmContainer.find("p").text(mChat.editInfo),phpbb.confirm(mChat.confirmContainer,function(){e.ajax(e.extend({},a,{data:{mode:"edit",message_id:t.data("id"),message:s.val()},beforeSend:function(){clearInterval(mChat.interval),mChat.userTimeout&&(clearInterval(mChat.activeInterval),clearInterval(mChat.counter))},success:function(a){t.fadeOut("slow",function(){t.replaceWith(e(a.edit).hide().fadeIn("slow"))})},complete:function(){mChat.interval=setInterval(mChat.refresh,mChat.refreshTime),mChat.userTimeout&&(mChat.sessionTime=mChat.userTimeout?mChat.userTimeout/1e3:!1,mChat.counter=setInterval(mChat.countDown,1e3),mChat.activeInterval=setInterval(mChat.active,mChat.userTimeout)),mChat.archiveMode||mChat.messageTop||setTimeout(function(){e("#mchat-main").animate({scrollTop:e("#mchat-main")[0].scrollHeight},"slow","swing")},250)}}))})},del:function(){var t=e(this).closest(".mchat-message");mChat.confirmContainer.find("textarea").hide(),mChat.confirmContainer.find("p").text(mChat.delConfirm),phpbb.confirm(mChat.confirmContainer,function(){e.ajax(e.extend({},a,{data:{mode:"del",message_id:t.data("id")},beforeSend:function(){clearInterval(mChat.interval),mChat.userTimeout&&(clearInterval(mChat.activeInterval),clearInterval(mChat.counter))},success:function(e){e.del&&(t.fadeOut("slow",function(){t.remove()}),mChat.sound("del"))},complete:function(){mChat.interval=setInterval(mChat.refresh,mChat.refreshTime),mChat.userTimeout&&(mChat.sessionTime=mChat.userTimeout?mChat.userTimeout/1e3:!1,mChat.counter=setInterval(mChat.countDown,1e3),mChat.activeInterval=setInterval(mChat.active,mChat.userTimeout))}}))})},refresh:function(){var t=mChat.messageTop?":first":":last",s=e("#mchat-messages").children(t).data("id");e.ajax(e.extend({},a,{data:{mode:"refresh",message_last_id:s},beforeSend:function(){e("#mchat-refresh-ok,#mchat-refresh-error,#mchat-refresh-paused").hide(),e("#mchat-refresh-load").show()},success:function(t){var a=e(t.refresh);a.length&&(e("#mchat-no-messages").remove(),e("#mchat-refresh-text").removeClass("mchat-alert"),e("#mchat-messages")[mChat.messageTop?"prepend":"append"](a.hide()),a.css("opacity",0).slideDown("slow").animate({opacity:1},{queue:!1,duration:"slow"}),e("#mchat-main").animate({scrollTop:mChat.messageTop?0:e("#mchat-main")[0].scrollHeight},"slow"),mChat.sound("add"),mChat.notice()),setTimeout(function(){e("#mchat-refresh-load,#mchat-refresh-error,#mchat-refresh-paused").hide(),e("#mchat-refresh-ok").show(),e("#mchat-refresh-text").html(mChat.refreshYes)},250)},error:function(){e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-paused").hide(),e("#mchat-refresh-error").show(),mChat.sound("error")}}))},whois:function(){e.ajax(e.extend({},a,{data:{mode:"whois"},beforeSend:function(){mChat.customPage&&(e("#mchat-refresh-pending").show(),e("#mchat-refresh").hide())},success:function(t){e("#mchat-whois").replaceWith(t.whois),mChat.customPage&&setTimeout(function(){e("#mchat-refresh-pending").hide(),e("#mchat-refresh").show()},250)},error:function(){mChat.sound("error")},complete:function(){e("#mchat-userlist").length&&("yes"==e.cookie("mChatShowUserList")||mChat.customPage)&&e("#mchat-userlist").css("display","block")}}))},active:function(){!mChat.archiveMode&&mChat.userTimeout&&(clearInterval(mChat.interval),clearInterval(mChat.whoisInterval),e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-error").hide(),e("#mchat-refresh-paused").show(),e("#mchat-refresh-text").html(mChat.refreshNo).addClass("mchat-alert"),e("#mchat-session").html(mChat.sessOut).addClass("mchat-alert"))},mention:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=t.data("usercolor");s?a="[b][color="+s+"]"+a+"[/color][/b]":mChat.allowBBCodes&&(a="[b]"+a+"[/b]"),insert_text("@ "+a+", ")},quote:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=mChat.entityDecode(t.data("edit"));insert_text('[quote="'+a+'"] '+s+"[/quote]")},like:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=mChat.entityDecode(t.data("edit"));insert_text(mChat.likes+'[quote="'+a+'"] '+s+"[/quote]")},entityDecode:function(e){var t=decodeURIComponent(e.replace(/\+/g," "));return t=t.replace(/&lt;/g,"<"),t=t.replace(/&gt;/g,">"),t=t.replace(/&#58;/g,":"),t=t.replace(/&#46;/g,"."),t=t.replace(/&amp;/g,"&"),t=t.replace(/&quot;/g,"'")}}),mChat.interval=setInterval(mChat.refresh,mChat.refreshTime),mChat.activeInterval=setInterval(mChat.active,mChat.userTimeout),mChat.sessionTime=mChat.userTimeout?mChat.userTimeout/1e3:!1,mChat.confirmContainer=e("#mchat-confirm").detach().show(),mChat.userTimeout&&(mChat.counter=setInterval(mChat.countDown,1e3)),mChat.whoisRefresh&&(mChat.whoisInterval=setInterval(mChat.whois,mChat.whoisRefresh)),"yes"==e.cookie("mChatShowSmiles")&&e("#mchat-smilies").css("display","none")&&e("#mchat-smilies").slideToggle("slow"),"yes"==e.cookie("mChatShowBBCodes")&&e("#mchat-bbcodes").css("display","none")&&e("#mchat-bbcodes").slideToggle("slow"),"yes"==e.cookie("mChatShowUserList")&&e("#mchat-userlist").length&&e("#mchat-userlist").slideToggle("slow"),"yes"==e.cookie("mChatShowColour")&&e("#mchat-colour").css("display","none")&&e("#mchat-colour").slideToggle("slow"),e("#mchat-user-sound").change(function(){e.cookie("mChatNoSound",e(this).is(":checked")?null:"yes")}),e("#mchat-colour").html(phpbb.colorPalette("h",15,10)).on("click","a",function(t){var a=e(this).data("color");bbfontstyle("[color=#"+a+"]","[/color]"),t.preventDefault()}),e("#mchat-body").on("click","[data-mchat-action]",function(t){var a=e(this).data("mchat-action");mChat[a].call(this),t.preventDefault()}),e("#mchat-body").on("click","[data-mchat-toggle]",function(t){var a=e(this).data("mchat-toggle");mChat.toggle(a),t.preventDefault()}),e("#postform").on("keypress",function(e){13==e.which&&(mChat.add(),e.preventDefault())})});
