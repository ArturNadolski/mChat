/**
 *
 * @package mChat JavaScript Code mini
 * @version 1.5.0 of 2015-12-27
 * @copyright (c) 2009 By Shapoval Andrey Vladimirovich (AllCity) ~ http://allcity.net.ru/
 * @copyright (c) 2013 By Rich McGirr (RMcGirr83) http://rmcgirr83.org
 * @copyright (c) 2015 By dmzx - http://www.dmzx-web.net
 * @copyright (c) 2015 By kasimi
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 *
 */
String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),String.prototype.capitalize||(String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}),"undefined"==typeof document.hasFocus&&(document.hasFocus=function(){return"visible"==document.visibilityState}),jQuery(function(e){var t={url:mChat.file,timeout:1e4,type:"POST",beforeSend:mChat.pauseSession,complete:mChat.resetSession,error:function(e,t,a){400==e.status?alert(mChat.flood):403==e.status?alert(mChat.noAccess):501==e.status?alert(mChat.noMessageInput):"undefined"!=typeof console&&console.log&&console.log("AJAX error. status: "+t+", message: "+a)}},a=function(e){return new Date(1e3*e).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]};e.extend(mChat,{clear:function(){""!==e("#mchat-input").val()&&(confirm(mChat.clearConfirm)&&(mChat.resetSession(),e("#mchat-input").val("")),e("#mchat-input").focus())},sound:function(t){Cookies.get("mChatNoSound")||(t=mChat.extUrl+"sounds/"+t+".swf",navigator.userAgent.match(/MSIE ([0-9]+)\./)||navigator.userAgent.match(/Trident\/7.0; rv 11.0/)?e("#mchat-sound").html('<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" height="0" width="0" type="application/x-shockwave-flash"><param name="movie" value="'+t+'"></object>'):e("#mchat-sound").html('<embed src="'+t+'" width="0" height="0" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash"></embed>'))},notice:function(){document.hasFocus()||e.titleAlert(mChat.newMessageAlert,{interval:1e3})},toggle:function(t){var a=e("#mchat-"+t);a.slideToggle(function(){var e="mChatShow"+t.capitalize();a.is(":visible")?Cookies.set(e,"yes"):Cookies.remove(e)})},add:function(){if(!mChat.submitting&&""!==e("#mchat-input").val()){var a=e("#mchat-input").val().replace(/ /g,"");if(mChat.mssgLngth&&a.length>mChat.mssgLngth)return void alert(mChat.mssgLngthLong);var s=e("#"+form_name+" :input[name]").filter(function(e,t){return!t.name.startsWith("addbbcode")});e.ajax(e.extend({},t,{data:s.serialize(),beforeSend:function(){e("#mchat-add").attr("disabled","disabled"),mChat.pauseSession()},success:mChat.refresh,complete:function(){mChat.resetSession(),e("#mchat-input").val("").focus(),e("#mchat-add").removeAttr("disabled")}}))}},edit:function(){var a=e(this).closest(".mchat-message"),s=mChat.confirmContainer.find("textarea").show().val(a.data("edit"));mChat.confirmContainer.find("p").text(mChat.editInfo),phpbb.confirm(mChat.confirmContainer,function(){e.ajax(e.extend({},t,{data:{mode:"edit",message_id:a.data("id"),message:s.val()},success:function(t){a.fadeOut("slow",function(){a.replaceWith(e(t.edit).hide().fadeIn("slow"))})},complete:function(){mChat.resetSession(),mChat.archiveMode||mChat.messageTop||setTimeout(function(){e("#mchat-main").animate({scrollTop:e("#mchat-main")[0].scrollHeight},"slow","swing")},250)}}))})},del:function(){var a=e(this).closest(".mchat-message");mChat.confirmContainer.find("textarea").hide(),mChat.confirmContainer.find("p").text(mChat.delConfirm),phpbb.confirm(mChat.confirmContainer,function(){e.ajax(e.extend({},t,{data:{mode:"del",message_id:a.data("id")},success:function(e){e.del&&(a.fadeOut("slow",function(){a.remove()}),mChat.sound("del"))}}))})},refresh:function(){var a=mChat.messageTop?":first":":last",s=e("#mchat-messages").children(a).data("id");e.ajax(e.extend({},t,{data:{mode:"refresh",message_last_id:s},beforeSend:function(){e("#mchat-refresh-ok,#mchat-refresh-error,#mchat-refresh-paused").hide(),e("#mchat-refresh-load").show()},success:function(t){var a=e(t.refresh);a.length&&(e("#mchat-no-messages").remove(),e("#mchat-messages")[mChat.messageTop?"prepend":"append"](a.hide()),a.css("opacity",0).slideDown("slow").animate({opacity:1},{queue:!1,duration:"slow"}),e("#mchat-main").animate({scrollTop:mChat.messageTop?0:e("#mchat-main")[0].scrollHeight},"slow"),mChat.sound("add"),mChat.notice()),setTimeout(function(){e("#mchat-refresh-load,#mchat-refresh-error,#mchat-refresh-paused").hide(),e("#mchat-refresh-ok").show(),e("#mchat-refresh-text").html(mChat.refreshYes)},250)},error:function(){e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-paused").hide(),e("#mchat-refresh-error").show(),mChat.sound("error")}}))},whois:function(){e.ajax(e.extend({},t,{data:{mode:"whois"},beforeSend:function(){mChat.customPage&&(e("#mchat-refresh-pending").show(),e("#mchat-refresh").hide())},success:function(t){e("#mchat-whois").replaceWith(t.whois),mChat.customPage&&setTimeout(function(){e("#mchat-refresh-pending").hide(),e("#mchat-refresh").show()},250)},error:function(){mChat.sound("error")},complete:function(){e("#mchat-userlist").length&&(Cookies.get("mChatShowUserlist")||mChat.customPage)&&e("#mchat-userlist").css("display","block")}}))},countDown:function(){mChat.sessionTime-=1;var t=a(mChat.sessionTime);e("#mchat-session").html(mChat.sessEnds+" "+t),mChat.sessionTime<=0&&mChat.endSession()},pauseSession:function(){mChat.submitting=!0,clearInterval(mChat.refreshInterval),mChat.userTimeout&&clearInterval(mChat.sessionCountdown),mChat.whoisRefresh&&clearInterval(mChat.whoisInterval)},resetSession:function(){clearInterval(mChat.refreshInterval),mChat.refreshInterval=setInterval(mChat.refresh,mChat.refreshTime),mChat.userTimeout&&(mChat.sessionTime=mChat.userTimeout/1e3,clearInterval(mChat.sessionCountdown),mChat.sessionCountdown=setInterval(mChat.countDown,1e3),e("#mchat-session").html(mChat.sessEnds+" "+a(mChat.sessionTime))),mChat.whoisRefresh&&(clearInterval(mChat.whoisInterval),mChat.whoisInterval=setInterval(mChat.whois,mChat.whoisRefresh)),e("#mchat-refresh-ok").show(),e("#mchat-refresh-load,#mchat-refresh-error,#mchat-refresh-paused").hide(),e("#mchat-refresh-text").html(mChat.refreshYes),mChat.submitting=!1},endSession:function(){clearInterval(mChat.refreshInterval),mChat.userTimeout&&(clearInterval(mChat.sessionCountdown),e("#mchat-session").html(mChat.sessOut)),mChat.whoisRefresh&&clearInterval(mChat.whoisInterval),e("#mchat-refresh-load,#mchat-refresh-ok,#mchat-refresh-error").hide(),e("#mchat-refresh-paused").show(),e("#mchat-refresh-text").html(mChat.refreshNo)},mention:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=t.data("usercolor");s?a="[b][color="+s+"]"+a+"[/color][/b]":mChat.allowBBCodes&&(a="[b]"+a+"[/b]"),insert_text("@ "+a+", ")},quote:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=mChat.entityDecode(t.data("edit"));insert_text('[quote="'+a+'"] '+s+"[/quote]")},like:function(){var t=e(this).closest(".mchat-message"),a=mChat.entityDecode(t.data("username")),s=mChat.entityDecode(t.data("edit"));insert_text(mChat.likes+'[quote="'+a+'"] '+s+"[/quote]")},entityDecode:function(e){var t=decodeURIComponent(e.replace(/\+/g," "));return t=t.replace(/&lt;/g,"<"),t=t.replace(/&gt;/g,">"),t=t.replace(/&#58;/g,":"),t=t.replace(/&#46;/g,"."),t=t.replace(/&amp;/g,"&"),t=t.replace(/&quot;/g,"'")}}),mChat.archiveMode||(e.fn.autoGrowInput=function(){return this.filter("input:text").each(function(){var t=20,a=e(this).width(),s="",o=e(this),n=e("<div>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:o.css("fontSize"),fontFamily:o.css("fontFamily"),fontWeight:o.css("fontWeight"),letterSpacing:o.css("letterSpacing"),whiteSpace:"nowrap"});n.insertAfter(o),e(this).on("keypress blur change submit focus",function(){if(s!==(s=o.val())){var h=s.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;"),i=n.html(h).width(),r=i+t>=a?i+t:a;(r<o.width()&&r>=a||r>a&&r<e(".mchat-panel").width()-t)&&o.width(r)}})}),this},mChat.resetSession(),mChat.messageTop||e("#mchat-main").animate({scrollTop:e("#mchat-main")[0].scrollHeight},"slow","swing"),e("input#mchat-input").autoGrowInput(),mChat.pause&&e("#mchat-input").on("keypress",mChat.endSession),mChat.playSound&&Cookies.get("mChatNoSound")?e("#mchat-user-sound").removeAttr("checked"):(Cookies.remove("mChatNoSound"),e("#mchat-user-sound").attr("checked","checked")),e("#mchat-user-sound").change(function(){this.checked?Cookies.remove("mChatNoSound"):Cookies.set("mChatNoSound","yes")}),e("#mchat-colour").html(phpbb.colorPalette("h",15,10)).on("click","a",function(t){var a=e(this).data("color");bbfontstyle("[color=#"+a+"]","[/color]"),t.preventDefault()}),Cookies.get("mChatShowSmilies")&&e("#mchat-smilies").slideToggle("slow"),Cookies.get("mChatShowBbcodes")&&e("#mchat-bbcodes").slideToggle("slow",function(){Cookies.get("mChatShowColour")&&e("#mchat-colour").slideToggle("slow")}),(Cookies.get("mChatShowUserlist")&&e("#mchat-userlist").length||mChat.customPage)&&e("#mchat-userlist").slideToggle("slow"),e("#postform").on("keypress",function(e){13==e.which&&(mChat.add(),e.preventDefault())})),mChat.confirmContainer=e("#mchat-confirm").detach().show(),e("#mchat-body").on("click","[data-mchat-action]",function(t){var a=e(this).data("mchat-action");mChat[a].call(this),t.preventDefault()}),e("#mchat-body").on("click","[data-mchat-toggle]",function(t){var a=e(this).data("mchat-toggle");mChat.toggle(a),t.preventDefault()})});
